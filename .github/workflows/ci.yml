name: CI release

on:
  push:


jobs:
  build:
    name: ${{ matrix.build.id }}
    runs-on: ${{ matrix.build.os }}
    timeout-minutes: 60
    strategy:
      matrix:
        build:
        - id: macos
          os: macOS-latest
          target: 'x86_64-apple-darwin'
        - id: macos-arm64
          os: macOS-latest
          target: 'aarch64-apple-darwin'
        - id: windows
          os: windows-latest
          target: 'x86_64-pc-windows-msvc'
        - id: linux
          os: ubuntu-latest
          target: 'x86_64-unknown-linux-gnu'

    env:
      GH_ACTIONS: true
      RUST_BACKTRACE: full

    steps:
      - name: Clone repository
        uses: actions/checkout@v2

      - name: Install stable rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          default: true
          target: ${{ matrix.build.target }}

      - name: Log versions
        run: |
          rustc --version
          cargo --version

      - name: Cache cargo registry
        uses: actions/cache@v1
        with:
          path: ~/.cargo/registry
          key: ${{ matrix.build.id }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      - name: Cache cargo index
        uses: actions/cache@v1
        with:
          path: ~/.cargo/git
          key: ${{ matrix.build.id }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
      - name: Cache cargo build
        uses: actions/cache@v1
        with:
          path: target
          key: ${{ matrix.build.id }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Install webkit2gtk
        if: matrix.build.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install libwebkit2gtk-4.0-dev

      - name: Run cargo build
        uses: actions-rs/cargo@v1
        with:
          command: build
          args: --release --target=${{ matrix.build.target }}

      - name: Package macOS
        if:  matrix.build.id == 'macos'
        run: mv target/${{ matrix.build.target }}/release/libwebview_deno.dylib libwebview_deno.x86_64.dylib

      - name: Package macOS-arm
        if:  matrix.build.id == 'macos-arm64'
        run: mv target/${{ matrix.build.target }}/release/libwebview_deno.dylib libwebview_deno.aarch64.dylib

      - name: Package Windows
        if:  matrix.build.id == 'windows'
        run: |
          mv target/${{ matrix.build.target }}/release/webview_deno.dll webview_deno.x86_64.dll
          mv target/${{ matrix.build.target }}/release/Webview2Loader.dll Webview2Loader.dll

      - name: Package Linux
        if:  matrix.build.id == 'linux'
        run: mv target/${{ matrix.build.target }}/release/webview_deno.so webview_deno.x86_64.so

      - uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.build.id }}
          path: |
            libwebview_deno.x86_64.dylib
            libwebview_deno.aarch64.dylib
            libwebview_deno.x86_64.so
            webview_deno.x86_64.dll
            Webview2Loader.dll

      - name: Release Plugin
        uses: softprops/action-gh-release@master
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "webview_deno release"
          draft: true
          files: |
            libwebview_deno.x86_64.dylib
            libwebview_deno.aarch64.dylib
            libwebview_deno.x86_64.so
            webview_deno.x86_64.dll
            Webview2Loader.dll
